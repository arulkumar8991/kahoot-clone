<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Game Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* --- SAME CSS AS YOUR VERSION (UNCHANGED) --- */
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: radial-gradient(circle at top,#1e3c4a,#0f2027);
  color: white;
  padding: 32px;
  text-align: center;
}

.view { display:none; }
.view.active { display:block; }

#question {
  font-size: 42px;
  font-weight: 800;
  margin-bottom: 36px;
}

.options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 22px;
  max-width: 1000px;
  margin: auto;
}

.option {
  padding: 36px;
  border-radius: 24px;
  font-size: 28px;
  font-weight: 800;
  color: white;
  min-height: 110px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 14px 30px rgba(0,0,0,0.35);
}

.opt-0 { background:#3b82f6; }
.opt-1 { background:#eab308; color:#1f2937; }
.opt-2 { background:#ef4444; }
.opt-3 { background:#22c55e; }

.chart {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  gap: 26px;
  height: 360px;
  margin: 60px auto;
}

.result-col {
  width: 160px;
  text-align: center;
}

.result-bar {
  height: 260px;
  background: rgba(255,255,255,0.15);
  border-radius: 18px;
  overflow: hidden;
  display: flex;
  align-items: flex-end;
  box-shadow: inset 0 0 10px rgba(0,0,0,.4);
}

.result-col.correct {
  transform: scale(1.08);
}

.result-col.correct .result-fill {
  background: linear-gradient(180deg,#16a34a,#22c55e);
  box-shadow: 0 0 30px rgba(34,197,94,.7);
}

.result-col.wrong {
  opacity: 0.15;   /* ‚¨ÖÔ∏è stronger dim */
  filter: grayscale(100%);
}

.result-col.correct .result-text {
  color: #22c55e;
  font-weight: 900;
}

.result-col.wrong .result-text {
  color: #9ca3af;
}


.result-text {
  margin-top: 14px;
  font-size: 18px;
  font-weight: 700;
}

.result-count {
  margin-top: 6px;
  font-size: 20px;
  font-weight: 800;
}

/* FINAL ANSWER STATE */
.result-col.correct .result-bar {
  background: linear-gradient(180deg,#16a34a,#22c55e);
  box-shadow: 0 0 28px rgba(34,197,94,.8);
}

.result-col.wrong .result-bar {
  background: linear-gradient(180deg,#dc2626,#ef4444);
  box-shadow: 0 0 18px rgba(239,68,68,.6);
}

.result-col.correct .result-text {
  color: #22c55e;
  font-weight: 900;
}

.result-col.wrong .result-text {
  color: #fca5a5;
}

.result-col.wrong {
  opacity: 0.85;
  filter: grayscale(30%);
}



#leaderboard {
  max-width: 520px;
  margin: 50px auto;
}

.lb-item {
  display:flex;
  justify-content:space-between;
  padding:16px 20px;
  margin-bottom:14px;
  border-radius:14px;
  background:rgba(255,255,255,0.12);
  font-size:22px;
}

.podium {
  display:flex;
  justify-content:center;
  align-items:flex-end;
  gap:28px;
}

.pillar {
  width:160px;
  border-radius:20px 20px 0 0;
  padding:18px;
  font-size:20px;
  font-weight:bold;
}

.first { height:240px; background:gold; color:#333 }
.second { height:190px; background:silver; color:#333 }
.third { height:160px; background:#cd7f32 }

#media {
  margin-bottom: 30px;
}

#media img {
  max-width: 90%;
  max-height: 420px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}

#media video {
  max-width: 90%;
  border-radius: 18px;
}

#media audio {
  width: 60%;
}

</style>
</head>

<body>
<div id="media"></div>
<div id="view-question" class="view active">
  <div id="question">Waiting for host‚Ä¶</div>
  <div class="options" id="options"></div>
</div>

<div id="view-chart" class="view">
  <h2>üìä Answers</h2>
  <div class="chart" id="chart"></div>
</div>

<div id="view-leaderboard" class="view">
  <h2>üèÜ Leaderboard</h2>
  <div id="leaderboard"></div>
</div>

<div id="view-podium" class="view">
  <h1>üéâ Winners</h1>
  <div class="podium">
    <div class="pillar second" id="p2"></div>
    <div class="pillar first" id="p1"></div>
    <div class="pillar third" id="p3"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
const pin = new URLSearchParams(location.search).get("pin");
const ws = new WebSocket(
  `${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/${pin}/SCREEN/Screen`
);

let rows = {};
let correctId = null;

function showView(id) {
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

ws.onmessage = e => {
  const d = JSON.parse(e.data);
  console.log("SCREEN EVENT:", d);

  if (d.type === "question") {
    showView("view-question");

    media.innerHTML = "";

    if (d.q_type === "image") {
      media.innerHTML = `<img src="${d.media}" />`;
    }

    if (d.q_type === "video") {
      media.innerHTML = `
        <video autoplay muted controls>
          <source src="${d.media}" type="video/mp4">
        </video>`;
    }

    if (d.q_type === "audio") {
      media.innerHTML = `
        <audio autoplay controls>
          <source src="${d.media}" type="audio/mpeg">
        </audio>`;
    }


    question.innerText = d.q;
    options.innerHTML = "";

    d.options.forEach((opt, i) => {
      const div = document.createElement("div");
      div.className = `option opt-${i}`;
      div.dataset.id = opt.id;   // ‚úÖ IMPORTANT
      div.innerText = opt.text;
      options.appendChild(div);
    });


    buildChart(d.options);
  }

  if (d.type === "stats") {
  const max = Math.max(...Object.values(d.counts), 1);

  Object.entries(d.counts).forEach(([id, count]) => {
    const col = rows[id];
    if (!col) return;

    col.querySelector(".result-count").innerText = count;
    col.querySelector(".result-fill").style.height =
      `${(count / max) * 100}%`;
  });
}


  if (d.type === "lock") {
    highlightCorrect(d.correct_id);
  }

  if (d.type === "show_chart") {
    media.innerHTML = "";
    showView("view-chart");
  }

  if (d.type === "leaderboard") {
    media.innerHTML = "";
    showView("view-leaderboard");
    renderLeaderboard(d.data);
  }
};

function buildChart(options) {
  chart.innerHTML = "";
  rows = {};

  options.forEach(opt => {
    const col = document.createElement("div");
    col.className = "result-col";
    col.dataset.id = String(opt.id); // ‚úÖ normalize

    col.innerHTML = `
      <div class="result-bar">
        <div class="result-fill"></div>
      </div>
      <div class="result-text">
        <span class="label">${opt.text}</span>
        <span class="icon" style="display:none">‚úî</span>
      </div>
      <div class="result-count">0</div>
    `;


    chart.appendChild(col);
    rows[String(opt.id)] = col; // ‚úÖ string key
  });
}


function highlightCorrect(correctId) {
  const cid = String(correctId);

  Object.entries(rows).forEach(([id, row]) => {
    row.classList.remove("correct", "wrong");

    if (id === cid) {
      row.classList.add("correct");
      row.querySelector(".icon").style.display = "inline";
    } else {
      row.classList.add("wrong");
    }
  });
}


function renderLeaderboard(data) {
  leaderboard.innerHTML = "";

  data.forEach((p, i) => {
    leaderboard.innerHTML += `
      <div class="lb-item">
        <span>${i + 1}. ${p.name}</span>
        <span>${p.score}</span>
      </div>
    `;
  });
}




function showPodium(data) {
  showView("view-podium");
  if (data[0]) p1.innerText = "ü•á " + data[0].name;
  if (data[1]) p2.innerText = "ü•à " + data[1].name;
  if (data[2]) p3.innerText = "ü•â " + data[2].name;
  confetti({ particleCount:220, spread:100, origin:{y:.6} });
}
</script>

</body>
</html>
